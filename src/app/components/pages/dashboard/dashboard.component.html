<section class="dashboard-page page">
  <div class="container">
    <!-- Admin view -->
    <app-dashboard-admin *ngIf="isAdmin"></app-dashboard-admin>

    <!-- User (non-admin) view -->
    <div *ngIf="!isAdmin">
    <h1 class="page-title">Dashboard do Usu√°rio</h1>

    <!-- Dynamic, draggable dashboard cards (fixed size, no resize) -->
    <div class="dashboard-grid" (dragover)="onDragOver($event)" (click)="clearSelection()">
   <div *ngFor="let card of cardOrder; let i = index" class="card-wrapper"
     draggable="true" (click)="onCardClick(i, $event)"
     (touchstart)="onTouchStart($event, i)" (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)"
     (dragstart)="onDragStart($event, i)" (dragover)="onDragOver($event)" (drop)="onDropNative($event,i)"
     (dragenter)="onDragEnter($event, i)" (dragleave)="onDragLeave($event, i)"
     [class.drag-over]="hoverIndex === i" [class.selected]="selectedCardIndex === i">
        <ng-container [ngSwitch]="card">
          <!-- Actions card -->
          <div *ngSwitchCase="'actions'" class="card action-card">
            <h3>A√ß√µes R√°pidas</h3>
            <div class="actions-list">
            <button class="btn-primary" type="button" (click)="goTo('/report')"><span class="btn-icon">üìù</span><span class="btn-text">Visita</span></button>
            <button class="btn-primary" type="button" (click)="goTo('/aep')"><span class="btn-icon">üõ°Ô∏è</span><span class="btn-text">AEP</span></button>
            <button class="btn-primary" type="button" (click)="goTo('/checklist')"><span class="btn-icon">‚úÖ</span><span class="btn-text">Check-List</span></button>
            <button class="btn-primary" type="button" (click)="goTo('/agenda')"><span class="btn-icon">‚ûï</span><span class="btn-text">Evento</span></button>
            </div>
          </div>

          <!-- KPIs card -->
          <div *ngSwitchCase="'kpis'" class="card kpi-card">
            <h3>Meus Indicadores (KPIs)</h3>
            <div class="kpi-grid">
              <div class="kpi-item">
                <div class="kpi-value">{{ kpis.totalVisits }}</div>
                <div class="kpi-label">Visitas registradas</div>
              </div>
              <div class="kpi-item">
                <div class="kpi-value">{{ kpis.totalAeps }}</div>
                <div class="kpi-label">Avalia√ß√µes AEP</div>
              </div>
              <div class="kpi-item">
                <div class="kpi-value">{{ kpis.totalRisks }}</div>
                <div class="kpi-label">Checklist de Riscos</div>
              </div>
              <div class="kpi-item">
                <div class="kpi-value">{{ kpis.totalVisitTime }}</div>
                <div class="kpi-label">Tempo total em visitas</div>
              </div>
            </div>
          </div>

          <!-- Top companies card -->
          <div *ngSwitchCase="'topCompanies'" class="card list-card">
            <h3>Top 5 Empresas</h3>
            <div class="companies-list">
              <div *ngIf="topCompanies && topCompanies.length > 0; else noCompanies">
                <div class="company-item" *ngFor="let c of topCompanies; let idx = index">
                  <div class="rank">#{{ idx + 1 }}</div>
                  <div class="company-info">
                    <div class="company-name">{{ c.companyName }}</div>
                    <div class="company-meta"><span class="doc-count">{{ c.documentCount }}</span> documentos</div>
                  </div>
                </div>
              </div>
              <ng-template #noCompanies>
                <div class="muted">Nenhuma empresa para exibir.</div>
              </ng-template>
            </div>
          </div>

          <!-- Agenda card -->
          <div *ngSwitchCase="'agenda'" class="card agenda-card">
            <h3>Minha Agenda (pr√≥ximos 5)</h3>
            <div class="agenda-list">
              <div *ngIf="myAgenda && myAgenda.length > 0; else noAgenda">
                <div class="agenda-item" *ngFor="let ev of myAgenda" [ngClass]="{ 'visita': ev.type === 'VISITA' }">
                  <div class="agenda-date">
                    <div class="dt-day">{{ ev.date.slice(8,10) }}</div>
                    <div class="dt-month">{{ ev.date.slice(5,7) }}</div>
                  </div>
                  <div class="agenda-body">
                    <div class="agenda-title">{{ ev.title }}</div>
                    <div class="agenda-meta">{{ ev.date.slice(0,10) }} ‚Ä¢ <span class="badge">{{ ev.type || 'EVENTO' }}</span></div>
                  </div>
                  <!-- removed 'Ver' button per design request -->
                  <div class="agenda-actions"></div>
                </div>
              </div>
              <ng-template #noAgenda>
                <div class="muted">Nenhum compromisso encontrado.</div>
              </ng-template>
            </div>
          </div>

          <!-- Recent card -->
          <div *ngSwitchCase="'recent'" class="card recent-card">
            <h3>Inspe√ß√µes Recentes</h3>
            <!-- keep the existing recent-table markup inside the card -->
            <div class="recent-table">
              <div class="recent-row header">
                <div class="col type">Tipo do documento</div>
                <div class="col title">T√≠tulo do documento</div>
                <div class="col company">Empresa / Cliente</div>
                <div class="col actions">A√ß√µes</div>
              </div>
              <div *ngIf="recentItems && recentItems.length > 0; else noRecent">
                <div class="recent-row" *ngFor="let item of recentItems" [class.signed]="isDocumentSigned(item)">
                  <div class="col type">
                    {{ item.type || '-' }}
                    <span *ngIf="isDocumentSigned(item)" class="signed-badge" title="Documento assinado e finalizado">üîí Finalizado</span>
                  </div>
                  <div class="col title">{{ item.title }}</div>
                  <div class="col company">{{ item.company || '-' }}</div>
                  <div class="col actions">
                    <button class="icon-btn" type="button" (click)="openDocument(item)" title="Visualizar">
                      <svg class="icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8S2 12 2 12z" stroke="#374151" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
                        <circle cx="12" cy="12" r="3" stroke="#374151" stroke-width="1.2" fill="none"></circle>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              <ng-template #noRecent>
                <div class="muted">Nenhum hist√≥rico dispon√≠vel.</div>
              </ng-template>
            </div>
          </div>

        </ng-container>
      </div>
    </div>
    </div>

    <!-- PDF viewer modal -->
    <div class="pdf-modal-overlay" *ngIf="pdfModalOpen" (click)="closePdfModal()">
      <div class="pdf-modal" (click)="$event.stopPropagation()">
        <div class="pdf-modal-header"><h4>Visualizador de PDF</h4><button class="btn-close" (click)="closePdfModal()">Fechar</button></div>
        <div class="pdf-modal-body">
          <iframe *ngIf="pdfBlobUrl" [src]="pdfBlobUrl | safeUrl" width="100%" height="600px" title="Visualizador de PDF"></iframe>
          <p *ngIf="!pdfBlobUrl">Carregando...</p>
        </div>
      </div>
    </div>

    <!-- recent items are rendered inside the dynamic 'recent' card above -->
  </div>
</section>
