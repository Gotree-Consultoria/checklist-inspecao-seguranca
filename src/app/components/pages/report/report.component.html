<section class="report-page">
  <div class="container">
    <h1 class="page-title">Relat√≥rio de Visita T√©cnica de Seguran√ßa do Trabalho</h1>

    <form id="reportForm" (submit)="$event.preventDefault()">
      <fieldset class="dados-relatorio">
        <legend>Dados do Relat√≥rio</legend>
        <div class="form-group">
          <div class="fields">
            <div class="field-row">
              <label for="empresaCliente" class="field-label">Empresa Cliente:</label>
              <div class="field-input">
                <select id="empresaCliente" name="empresaCliente" class="form-select" title="Selecione a empresa cliente" (change)="onCompanyChange($event)">
                  <option value="">Selecione uma empresa</option>
                </select>
              </div>
            </div>

            <div class="field-row">
              <label for="empresaCnpj" class="field-label">CNPJ:</label>
              <div class="field-input">
                <input type="text" id="empresaCnpj" name="empresaCnpj" class="form-control" placeholder="00.000.000/0000-00" />
              </div>
            </div>

            <div class="field-row">
              <label for="empresaUnidade" class="field-label">Unidade:</label>
              <div class="field-input">
                <select id="empresaUnidade" name="empresaUnidade" class="form-select" disabled>
                  <option value="">Selecione uma empresa primeiro</option>
                </select>
              </div>
            </div>

            <div class="field-row">
              <label for="empresaSetor" class="field-label">Setor:</label>
              <div class="field-input">
                <select id="empresaSetor" name="empresaSetor" class="form-select" disabled>
                  <option value="">Selecione uma empresa primeiro</option>
                </select>
              </div>
            </div>

            <div class="section-separator" aria-hidden="true"></div>

            <div class="field-row">
              <label for="reportTitle" class="field-label">T√≠tulo do Documento:</label>
              <div class="field-input">
                <input type="text" id="reportTitle" class="form-control" placeholder="Ex: Inspe√ß√£o Rotina - Setor A" />
              </div>
            </div>

            <div class="field-row">
              <label for="dataInspecao" class="field-label">Data da Visita</label>
              <div class="field-input">
                <input type="date" id="dataInspecao" name="dataInspecao" class="form-control" required />
              </div>
            </div>

            <div class="field-row">
              <label for="responsavel" class="field-label">Respons√°vel pela Visita:</label>
              <div class="field-input">
                <input type="text" id="responsavel" name="responsavel" class="form-control" required />
              </div>
            </div>

            <div class="field-row">
              <label for="responsavelSigla" class="field-label">Sigla do Conselho:</label>
              <div class="field-input">
                <input type="text" id="responsavelSigla" name="responsavelSigla" class="form-control" />
              </div>
            </div>

            <div class="field-row">
              <label for="responsavelRegistro" class="field-label">Registro do Conselho:</label>
              <div class="field-input">
                <input type="text" id="responsavelRegistro" name="responsavelRegistro" class="form-control" />
              </div>
            </div>

            <div class="field-row">
              <label for="localInspecao" class="field-label">Local da Visita</label>
              <div class="field-input">
                <input type="text" id="localInspecao" name="localInspecao" class="form-control" placeholder="ex.: fabrica/escrit√≥rio/banheiro" required />
              </div>
            </div>
          </div>
        </div>
      </fieldset>

      <div class="form-group">
        <div>
          <label for="reportStartTime" class="form-label">Hora inicial</label>
          <input type="time" id="reportStartTime" class="form-control time-input" step="1" />
        </div>
        <div id="reportEndContainer" class="hidden">
          <label for="reportEndTime" class="form-label">Hora final</label>
          <input type="time" id="reportEndTime" class="form-control time-input" step="1" readonly />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Refer√™ncias T√©cnicas Utilizadas (informativo)</label>
        <ul id="referencesList">
          <li>INSPE√á√ÉO Meio Ambiente</li>
          <li>INSPE√á√ÉO NR 01 - Documenta√ß√µes</li>
          <li>INSPE√á√ÉO NR 06 - EPI (Equipamento de Prote√ß√£o Individual)</li>
          <li>INSPE√á√ÉO NR 06 - EPC (Equipamento de Prote√ß√£o Coletiva)</li>
          <li>INSPE√á√ÉO NR 07 - Documenta√ß√µes</li>
          <li>INSPE√á√ÉO NR 11 - Transporte, movimenta√ß√£o, manuseio e armazenagem de materiais</li>
          <li>INSPE√á√ÉO NR 12 - M√°quinas e equipamentos</li>
          <li>INSPE√á√ÉO NR 23 - Prote√ß√£o e Combate Contra Inc√™ndios</li>
          <li>INSPE√á√ÉO NR 35 - Trabalho em altura</li>
        </ul>
      </div>

      <div class="form-group">
        <label for="reportSummary" class="form-label">Resumo geral da visita</label>
        <textarea id="reportSummary" class="form-control" rows="4"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Registros Fotogr√°ficos</label>
        <p class="record-instructions">Adicione registros com foto (captura ou upload), descri√ß√£o e metadados. Cada clique em "Novo Registro" cria um novo bloco abaixo.</p>
        <div class="record-add">
          <button type="button" id="addRecordBtn" class="btn-add-empresa btn-sm add-record-btn" (click)="addRecord()">
            <span class="icon" aria-hidden="true">‚ûï</span>
            <span>Novo Registro</span>
          </button>
        </div>
      </div>

      <div id="recordsContainer" class="records-list">
        <div class="record-item" *ngFor="let record of records; let i = index; trackBy: trackByIndex">
          <div class="record-meta">
            <!-- Fotos com dois slots -->
            <div class="photo-section">
              <label class="photo-label">Fotos do Registro (m√°x. 2)</label>
              <div class="record-photos">
                <div class="photo-slot" [class.empty]="!record.photos[0]">
                  <img *ngIf="record.photos[0]" [src]="record.photos[0]" alt="Foto 1" class="rec-img" />
                  <input type="file" accept="image/*" title="Upload de foto 1" (change)="onRecordFileChange($event, i, 0)" />
                </div>
                <div class="photo-slot" [class.empty]="!record.photos[1]">
                  <img *ngIf="record.photos[1]" [src]="record.photos[1]" alt="Foto 2" class="rec-img" />
                  <input type="file" accept="image/*" title="Upload de foto 2" (change)="onRecordFileChange($event, i, 1)" />
                </div>
              </div>
              <div class="photo-actions">
                <button type="button" class="btn-secondary btn-sm" (click)="onSelectFileClick(i)" title="Selecionar foto da galeria ou computador">
                  üìÅ Galeria
                </button>
                <button type="button" class="btn-secondary btn-sm" (click)="onCaptureClick(i)" title="Usar c√¢mera para capturar foto">
                  üì∑ Capturar
                </button>
                <button type="button" class="btn-secondary btn-sm" (click)="removePhotos(i)" *ngIf="record.photos.length > 0" title="Remover todas as fotos">
                  üóëÔ∏è Remover
                </button>
              </div>
            </div>

            <!-- Campos de descri√ß√£o -->
            <div class="record-fields">
              <div class="field-row-inline">
                <label for="rec-desc-{{i}}" class="field-label">Descri√ß√£o:</label>
                <input type="text" [id]="'rec-desc-' + i" [name]="'rec-desc-' + i" [(ngModel)]="record.description" (change)="onRecordChange(i)" class="form-control" placeholder="Descri√ß√£o do achado" />
              </div>

              <div class="field-row-inline">
                <label for="rec-conseq-{{i}}" class="field-label">Consequ√™ncias:</label>
                <input type="text" [id]="'rec-conseq-' + i" [name]="'rec-conseq-' + i" [(ngModel)]="record.consequences" (change)="onRecordChange(i)" class="form-control" placeholder="Consequ√™ncias potenciais" />
              </div>

              <div class="field-row-inline">
                <label for="rec-legal-{{i}}" class="field-label">Orienta√ß√£o Legal:</label>
                <input type="text" [id]="'rec-legal-' + i" [name]="'rec-legal-' + i" [(ngModel)]="record.legal" (change)="onRecordChange(i)" class="form-control" placeholder="Base legal ou normativa" />
              </div>

              <div class="field-row-inline">
                <label for="rec-penal-{{i}}" class="field-label">Penalidades:</label>
                <input type="text" [id]="'rec-penal-' + i" [name]="'rec-penal-' + i" [(ngModel)]="record.penalties" (change)="onRecordChange(i)" class="form-control" placeholder="Penalidades aplic√°veis" />
              </div>

              <div class="field-row-inline">
                <label for="rec-resp-{{i}}" class="field-label">Respons√°vel:</label>
                <input type="text" [id]="'rec-resp-' + i" [name]="'rec-resp-' + i" [(ngModel)]="record.responsible" (change)="onRecordChange(i)" class="form-control" placeholder="Respons√°vel pela corre√ß√£o" />
              </div>

              <div class="field-row-inline">
                <label for="rec-priority-{{i}}" class="field-label">Prioridade:</label>
                <select [id]="'rec-priority-' + i" [name]="'rec-priority-' + i" [(ngModel)]="record.priority" (change)="onRecordChange(i)" class="form-select" title="Selecione a prioridade do achado">
                  <option value="Alta">Alta</option>
                  <option value="Media">M√©dia</option>
                  <option value="Baixa">Baixa</option>
                </select>
              </div>

              <div class="field-row-inline">
                <label for="rec-deadline-{{i}}" class="field-label">Prazo:</label>
                <input type="date" [id]="'rec-deadline-' + i" [name]="'rec-deadline-' + i" [(ngModel)]="record.deadline" (change)="onRecordChange(i)" class="form-control" title="Selecione a data do prazo" />
              </div>

              <div class="field-row-inline">
                <label for="rec-unchanged-{{i}}" class="field-label">Reincid√™ncia:</label>
                <select [id]="'rec-unchanged-' + i" [name]="'rec-unchanged-' + i" [(ngModel)]="record.unchanged" (change)="onRecordChange(i)" class="form-select" title="Indica se √© uma reincid√™ncia">
                  <option value="Sim">Sim</option>
                  <option value="N√£o">N√£o</option>
                </select>
              </div>

              <div class="record-actions">
                <button type="button" class="btn-secondary" (click)="removeRecord(i)" title="Remover este registro">
                  üóëÔ∏è Remover Registro
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="record-add-bottom">
        <button type="button" id="addRecordBtnBottom" class="btn-add-empresa btn-sm add-record-btn" (click)="addRecord()">
          <span class="icon" aria-hidden="true">‚ûï</span>
          <span>Novo Registro</span>
        </button>
      </div>

      <div class="form-actions">
        <button type="button" id="saveReportBtn" class="btn-submit" (click)="handleSaveClick($event)">Prosseguir para Assinatura</button>
      </div>
    </form>
  </div>
</section>

<!-- Modal de assinaturas (mantemos igual ao legacy para compatibilidade com o m√≥dulo legacy) -->
<div id="reportSignatureModal" class="modal-overlay hidden" aria-hidden="true">
  <div class="modal">
    <div class="modal-header"><h3>Assinaturas</h3></div>
    <div class="modal-body">
      <p>Por favor, colete a assinatura do T√©cnico e do Cliente.</p>
      <div class="sign-block">
        <h4>T√©cnico</h4>
        <div class="fg">
          <label for="techNameReport">Nome do T√©cnico</label>
          <input type="text" id="techNameReport" class="form-control" readonly />
        </div>
        <div class="fg">
          <label>Assinatura do T√©cnico</label>
          <canvas id="techSignatureCanvasReport" class="signature-canvas"></canvas>
          <div class="signature-clear-btn"><button type="button" id="clearTechSigReport" class="btn-secondary">Limpar Assinatura (T√©cnico)</button></div>
        </div>
      </div>

      <hr />

      <div class="sign-block">
        <h4>Respons√°vel</h4>
        <div class="fg">
          <label for="clientSignerName">Nome do Respons√°vel</label>
          <input type="text" id="clientSignerName" class="form-control" placeholder="Nome do respons√°vel" />
        </div>
        <div class="fg">
          <label>Assinatura do Respons√°vel</label>
          <canvas id="clientSignatureCanvasReport" class="signature-canvas"></canvas>
          <div class="signature-clear-btn"><button type="button" id="clearClientSigReport" class="btn-secondary">Limpar Assinatura (Respons√°vel)</button></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" id="clearAllSignaturesBtnReport" class="btn-secondary">Limpar</button>
      <button type="button" id="confirmSendReportBtn" class="btn-submit">Confirmar e Enviar</button>
      <button type="button" id="cancelSendReportBtn" class="btn-secondary">Cancelar</button>
    </div>
  </div>
</div>
