<section class="group-page">
	<div class="container">
		<h1 class="page-title">Gerenciamento de Inspe√ß√µes de Seguran√ßa</h1>

		<div class="action-buttons">
			<button class="action-btn action-report create-report" (click)="go('report')">
				<span class="icon">üìù</span>
				<span class="text">
					<strong>Novo Relat√≥rio</strong>
					<small>Registro fotogr√°fico</small>
				</span>
			</button>
			<button class="action-btn action-aep create-aep" (click)="go('aep')">
				<span class="icon">üõ°Ô∏è</span>
				<span class="text">
					<strong>Novo AEP</strong>
					<small>Registro de AEP</small>
				</span>
			</button>
			<button class="action-btn action-checklist create-checklist" (click)="go('checklist')">
				<span class="icon">‚úÖ</span>
				<span class="text">
					<strong>Check-List</strong>
					<small>Lista de verifica√ß√£o</small>
				</span>
			</button>
		</div>

		<!-- Pr√≥ximos eventos / visitas (Agenda) - Oculto para ADMIN -->
		<div class="upcoming-section" *ngIf="userProfile?.role !== 'ADMIN'">
			<h2>Pr√≥ximos eventos / visitas</h2>
			<div *ngIf="loadingUpcoming" class="small-muted">Carregando pr√≥ximos eventos...</div>
			<div *ngIf="!loadingUpcoming && (upcomingEventsAll.length===0)" class="small-muted">Nenhum evento agendado.</div>
		<ul *ngIf="!loadingUpcoming && upcomingEventsAll.length" class="upcoming-list">
			<li *ngFor="let ev of upcomingEventsAll" class="upcoming-item">
					<div class="ev-date">{{ formatDateToBrazil(ev.date) }}</div>
					<div class="ev-body">
						<div class="ev-title">{{ ev.title }} <span class="agenda-badge" [ngClass]="{ 'visita': ev.type==='VISITA', 'evento': ev.type==='EVENTO' }">{{ ev.type }}</span></div>
						<div class="ev-sub">{{ ev.unitName || '' }}<span *ngIf="ev.unitName && ev.sectorName"> ‚Ä¢ </span>{{ ev.sectorName || '' }}</div>
					</div>
			</li>
		</ul>
	</div>		<div class="history-section">
			<h2>Hist√≥rico</h2>
			<div class="table-container">
				<table>
					<thead>
						<tr>
							<th>Tipo</th>
							<th>T√≠tulo</th>
							<th>Empresa</th>
							<th>Data</th>
							<th>A√ß√µes</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngIf="loading">
							<td colspan="5">Carregando...</td>
						</tr>
						<tr *ngIf="!loading && history.length === 0">
							<td colspan="5">Nenhum hist√≥rico encontrado.</td>
						</tr>
					<tr *ngFor="let item of history" [attr.data-doc-id]="item.id || item.reportId">
						<td data-label="Tipo">{{ formatDocumentType(item.type || item.documentType) }}</td>
						<td data-label="T√≠tulo">{{ item.title || item.type || 'Documento' }}</td>
						<td data-label="Empresa">{{ item.clientName || item.companyName || item.company || '' }}</td>
						<td data-label="Data">{{ formatDateToBrazil(item.creationDate || item.inspectionDate || item.createdAt) }}</td>
							<td class="actions-cell" data-label="A√ß√µes">
								<button class="icon-btn" (click)="downloadDoc(item)" title="Baixar">
									<svg class="icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
										<path d="M12 3v12" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
										<path d="M8 9l4 4 4-4" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
										<path d="M21 21H3" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
									</svg>
								</button>
								<button class="icon-btn" (click)="viewDoc(item)" title="Visualizar">
									<svg class="icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
										<path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8S2 12 2 12z" stroke="#374151" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
										<circle cx="12" cy="12" r="3" stroke="#374151" stroke-width="1.2" fill="none"></circle>
									</svg>
								</button>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- PDF Modal Overlay -->
	<div class="pdf-modal-overlay" *ngIf="pdfModalOpen" (click)="closePdfModal()">
		<div class="pdf-modal" (click)="$event.stopPropagation()">
				<div class="pdf-modal-header">
					<div class="pdf-toolbar">
						<h4>Visualizador de PDF</h4>
						<div class="pdf-actions">
							<button class="btn-action" *ngIf="pdfBlobUrl && pdfModalItem" (click)="downloadDoc(pdfModalItem)">Baixar</button>
							<button class="btn-action" *ngIf="pdfBlobUrl" (click)="openPdfInNewTab()">Abrir em nova aba</button>
							<button class="btn-close" (click)="closePdfModal()">Fechar</button>
						</div>
					</div>
				</div>
				<div class="pdf-modal-body">
					<iframe *ngIf="pdfBlobUrl" [src]="pdfBlobUrl | safeUrl" width="100%" height="600px" title="Visualizador de PDF"></iframe>
					<p *ngIf="!pdfBlobUrl">Carregando...</p>
				</div>
			</div>
	</div>

	<!-- Password Reset Required Modal -->
	<div *ngIf="showResetPasswordModal" class="modal-overlay">
		<div class="modal-content" (click)="$event.stopPropagation()">
			<div class="modal-header">
				<h2>Alterar Senha Obrigatoriamente</h2>
				<p class="modal-subtitle">Sua senha expirou. Por favor, escolha uma nova senha para continuar.</p>
			</div>

			<form (submit)="submitResetPassword()" class="reset-password-form" novalidate>
				<div class="form-group">
					<label for="newPassword">Nova Senha</label>
					<input 
						type="password" 
						id="newPassword" 
						class="form-control"
						[(ngModel)]="resetPasswordForm.newPassword"
						name="newPassword"
						placeholder="M√≠nimo 8 caracteres"
						required
						[disabled]="resetPasswordLoading"
						autocomplete="new-password"
					/>
				</div>

				<div class="form-group">
					<label for="confirmPassword">Confirmar Senha</label>
					<input 
						type="password" 
						id="confirmPassword" 
						class="form-control"
						[(ngModel)]="resetPasswordForm.confirmPassword"
						name="confirmPassword"
						placeholder="Repita a nova senha"
						required
						[disabled]="resetPasswordLoading"
						autocomplete="new-password"
					/>
				</div>

				<div *ngIf="resetPasswordError" class="error-message" role="alert">
					{{ resetPasswordError }}
				</div>

				<div class="form-actions">
					<button 
						type="submit" 
						class="btn btn-primary"
						[disabled]="resetPasswordLoading"
					>
						{{ resetPasswordLoading ? 'Alterando...' : 'Alterar Senha' }}
					</button>
				</div>
			</form>
			
			<p class="modal-info">Este √© um passo obrigat√≥rio de seguran√ßa. Voc√™ n√£o conseguir√° sair sem alterar sua senha.</p>
		</div>
	</div>
</section>
