<div class="page admin-page">
  <div *ngIf="accessDenied" class="access-denied">
    <div class="denied-container">
      <div class="denied-icon">ğŸ”’</div>
      <h1>Acesso Negado</h1>
      <p>VocÃª nÃ£o possui permissÃ£o para acessar este painel.</p>
    </div>
  </div>

  <div *ngIf="!accessDenied" class="admin-container">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <h1>Painel Administrativo</h1>
        <p class="subtitle">Gerencie usuÃ¡rios e empresas do sistema</p>
      </div>
    </div>

    <!-- ConteÃºdo -->
    <div class="admin-content">
      <!-- SeÃ§Ã£o de UsuÃ¡rios -->
      <section class="admin-section users-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <div class="section-icon">ğŸ‘¥</div>
            <div>
              <h2>UsuÃ¡rios</h2>
              <p class="section-subtitle">Gerenciar usuÃ¡rios do sistema</p>
            </div>
          </div>
          <div class="user-count" *ngIf="users && users.length">{{users.length}} usuÃ¡rio(s)</div>
        </div>

        <!-- Tabela de UsuÃ¡rios -->
        <div class="section-body">
          <div *ngIf="loadingUsers" class="loading-state">
            <div class="spinner"></div>
            <p>Carregando usuÃ¡rios...</p>
          </div>
          <div *ngIf="!loadingUsers && (!users || users.length===0)" class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>Nenhum usuÃ¡rio encontrado</p>
          </div>

          <div *ngIf="users && users.length" class="table-wrapper">
            <table class="users-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Email</th>
                  <th>Perfil</th>
                  <th>Conselho</th>
                  <th>Contato</th>
                  <th class="actions-col">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let u of users" class="user-row">
                  <td class="user-name">{{u.name}}</td>
                  <td class="user-email">{{u.email}}</td>
                  <td>
                    <span class="badge" [class.badge-admin]="u.role==='ADMIN'" [class.badge-user]="u.role==='USER'">
                      {{u.role || 'USER'}}
                    </span>
                  </td>
                  <td class="council-info">
                    <span *ngIf="u.siglaConselhoClasse || u.councilAcronym" class="council-text">
                      {{u.siglaConselhoClasse || u.councilAcronym}} - {{u.conselhoClasse || u.councilNumber}}
                    </span>
                    <span *ngIf="!(u.siglaConselhoClasse || u.councilAcronym)" class="text-muted">-</span>
                  </td>
                  <td class="phone-info">{{u.phone || '-'}}</td>
                  <td class="actions-col">
                    <button class="btn-action btn-edit" (click)="openEditUserModal(u)" title="Editar usuÃ¡rio">
                      âœï¸
                    </button>
                    <button class="btn-action btn-delete" *ngIf="(u.role||'').toUpperCase()!=='ADMIN'" (click)="deleteUser(u.id)" title="Excluir usuÃ¡rio">
                      ğŸ—‘ï¸
                    </button>
                    <button class="btn-action btn-reset" *ngIf="(u.role||'').toUpperCase()!=='ADMIN'" (click)="resetUserPassword(u.id)" title="Resetar senha">
                      ğŸ”‘
                    </button>
                    <span class="protected" *ngIf="(u.role||'').toUpperCase()==='ADMIN'" title="UsuÃ¡rio administrador">ğŸ”’</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- FormulÃ¡rio de CriaÃ§Ã£o -->
        <div class="form-section">
          <div class="form-header">
            <h3>â• Novo UsuÃ¡rio</h3>
          </div>
          <form (ngSubmit)="submitCreateUser()" [formGroup]="userForm" class="form-grid">
            <div class="form-group">
              <label>Nome *</label>
              <input placeholder="Nome completo" formControlName="name" />
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input placeholder="email@exemplo.com" formControlName="email" type="email" />
            </div>
            <div class="form-group">
              <label>Senha *</label>
              <input placeholder="MÃ­nimo 8 caracteres" formControlName="password" type="password" />
            </div>
            <div class="form-group">
              <label>Data de Nascimento *</label>
              <input formControlName="birthDate" type="date" title="Data de nascimento" />
            </div>
            <div class="form-group">
              <label>Telefone *</label>
              <input placeholder="(00) 00000-0000" formControlName="phone" />
            </div>
            <div class="form-group">
              <label>CPF *</label>
              <input placeholder="000.000.000-00" formControlName="cpf" />
            </div>
            <div class="form-group">
              <label>Perfil</label>
              <select formControlName="role" title="Perfil do usuÃ¡rio">
                <option value="USER">UsuÃ¡rio</option>
                <option value="ADMIN">Administrador</option>
              </select>
            </div>
            <div class="form-group">
              <label>Sigla Conselho</label>
              <input placeholder="CRMV, OAB, etc..." formControlName="councilAcronym" />
            </div>
            <div class="form-group">
              <label>NÃºmero Conselho</label>
              <input placeholder="NÃºmero do conselho" formControlName="councilNumber" />
            </div>
            <div class="form-group">
              <label>Especialidade</label>
              <input placeholder="Ex: cardiologia" formControlName="specialty" />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">ğŸ’¾ Salvar UsuÃ¡rio</button>
            </div>
            <div class="form-message" *ngIf="userFormMsg" [class.success]="userFormMsg.includes('sucesso')">{{userFormMsg}}</div>
          </form>
        </div>
      </section>

      <!-- SeÃ§Ã£o de Empresas -->
      <section class="admin-section companies-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <div class="section-icon">ğŸ¢</div>
            <div>
              <h2>Empresas</h2>
              <p class="section-subtitle">Gerenciar empresas cadastradas</p>
            </div>
          </div>
          <div class="header-actions">
            <button type="button" class="btn btn-secondary" (click)="downloadTemplate()" title="Baixar modelo vazio para importaÃ§Ã£o">
              ğŸ“‹ Modelo
            </button>
            <button type="button" class="btn btn-secondary" (click)="downloadExport()" [disabled]="isExporting" title="Exportar dados atuais em Excel">
              {{ isExporting ? 'â³ Exportando...' : 'ğŸ“¥ Exportar Dados' }}
            </button>
            <label class="btn btn-secondary" [class.disabled]="uploadingFile" [title]="uploadingFile ? 'Importando...' : 'Selecionar planilha para importaÃ§Ã£o'">
              {{ selectedFile ? 'âœ“ ' + selectedFile.name : 'ğŸ“¤ Importar' }}
              <input 
                type="file" 
                id="fileInput"
                accept=".xlsx,.xls,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                (change)="onFileSelected($event)" 
                [disabled]="uploadingFile"
              />
            </label>
            <button 
              type="button" 
              class="btn btn-primary" 
              *ngIf="selectedFile"
              (click)="uploadFile()" 
              [disabled]="uploadingFile"
              [title]="uploadingFile ? 'Importando...' : 'Confirmar importaÃ§Ã£o'"
            >
              {{ uploadingFile ? 'â³ Importando...' : 'âœ“ Confirmar' }}
            </button>
            <button 
              type="button" 
              class="btn btn-cancel" 
              *ngIf="selectedFile"
              (click)="cancelUpload()"
              [disabled]="uploadingFile"
              title="Cancelar importaÃ§Ã£o"
            >
              âœ• Cancelar
            </button>
            <div class="company-count" *ngIf="companies && companies.length">{{companies.length}} empresa(s)</div>
          </div>
        </div>

        <!-- Mensagem de ImportaÃ§Ã£o -->
        <div *ngIf="importMsg" class="import-message" [class.success]="importMsg.includes('âœ…')" [class.error]="importMsg.includes('âŒ')" [class.warning]="importMsg.includes('âš ï¸')">
          {{importMsg}}
        </div>

        <!-- Lista de Empresas -->
        <div class="section-body">
          <div *ngIf="loadingCompanies" class="loading-state">
            <div class="spinner"></div>
            <p>Carregando empresas...</p>
          </div>
          <div *ngIf="!loadingCompanies && (!companies || companies.length===0)" class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>Nenhuma empresa encontrada</p>
          </div>
          <div *ngIf="companies && companies.length" class="companies-table-wrapper">
            <table class="companies-table">
              <thead>
                <tr>
                  <th>Empresa</th>
                  <th>CNPJ</th>
                  <th>Unidades</th>
                  <th>Setores</th>
                  <th class="actions-col">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let c of companies" class="company-row">
                  <td class="company-name-cell">{{c.name}}</td>
                  <td class="company-cnpj-cell">{{c.cnpj | cnpjFormat}}</td>
                  <td class="company-units-cell">ğŸ“¦ {{(c.units || []).length}}</td>
                  <td class="company-sectors-cell">ğŸ·ï¸ {{(c.sectors || []).length}}</td>
                  <td class="actions-col">
                    <button type="button" class="btn-action btn-edit" (click)="openEditCompanyModal(c)" title="Editar">âœï¸</button>
                    <button type="button" class="btn-action btn-delete" (click)="deleteCompany(c.id)" title="Excluir">ğŸ—‘ï¸</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- PaginaÃ§Ã£o -->
            <div class="pagination-wrapper" *ngIf="totalPages > 1">
              <div class="pagination-info">
                <span>PÃ¡gina {{currentPage + 1}} de {{totalPages}} (Total: {{totalElements}} empresa(s))</span>
              </div>
              <div class="pagination-controls">
                <button 
                  type="button" 
                  class="btn btn-pagination" 
                  (click)="onPageChange(0)"
                  [disabled]="currentPage === 0"
                  title="Primeira pÃ¡gina"
                >
                  â®ï¸ Primeira
                </button>
                <button 
                  type="button" 
                  class="btn btn-pagination" 
                  (click)="onPageChange(currentPage - 1)"
                  [disabled]="currentPage === 0"
                  title="PÃ¡gina anterior"
                >
                  â—€ï¸ Anterior
                </button>
                
                <!-- NÃºmeros de pÃ¡gina -->
                <div class="pagination-numbers">
                  <button 
                    *ngFor="let p of [].constructor(totalPages); let i = index"
                    type="button" 
                    class="btn btn-page-number"
                    [class.active]="i === currentPage"
                    (click)="onPageChange(i)"
                    title="PÃ¡gina {{i + 1}}"
                  >
                    {{i + 1}}
                  </button>
                </div>

                <button 
                  type="button" 
                  class="btn btn-pagination" 
                  (click)="onPageChange(currentPage + 1)"
                  [disabled]="currentPage === totalPages - 1"
                  title="PrÃ³xima pÃ¡gina"
                >
                  PrÃ³xima â–¶ï¸
                </button>
                <button 
                  type="button" 
                  class="btn btn-pagination" 
                  (click)="onPageChange(totalPages - 1)"
                  [disabled]="currentPage === totalPages - 1"
                  title="Ãšltima pÃ¡gina"
                >
                  Ãšltima â­ï¸
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- FormulÃ¡rio de CriaÃ§Ã£o -->
        <div class="form-section">
          <div class="form-header">
            <h3>â• Nova Empresa</h3>
          </div>
          <form (ngSubmit)="submitCreateCompany()" [formGroup]="companyForm" class="form-grid">
            <div class="form-group full-width">
              <label>Nome da Empresa *</label>
              <input placeholder="RazÃ£o social" formControlName="companyName" />
            </div>
            <div class="form-group full-width">
              <label>CNPJ *</label>
              <input placeholder="00.000.000/0000-00" formControlName="companyCnpj" (change)="onCnpjChange($event.target.value, 'company')" />
            </div>

            <!-- Unidades -->
            <div class="form-group full-width">
              <label class="dynamic-label">ğŸ­ Unidades</label>
              <div class="dynamic-items">
                <div *ngFor="let u of dynamicUnits; let i = index" class="dynamic-item">
                  <span class="item-name">{{u.name}}</span>
                  <span class="item-detail" *ngIf="u.cnpj">{{u.cnpj | cnpjFormat}}</span>
                  <span class="item-detail text-muted" *ngIf="!u.cnpj">(sem CNPJ)</span>
                  <button type="button" class="btn-remove" (click)="removeUnit(i)" title="Remover">âœ•</button>
                </div>
              </div>
              <div class="add-dynamic">
                <input #unitNameInput placeholder="Nome da unidade" class="dynamic-input" />
                <input #unitCnpjInput placeholder="CNPJ (opcional)" class="dynamic-input" (change)="onUnitCnpjChange($event.target.value, unitNameInput)" />
                <button type="button" class="btn btn-secondary btn-sm" (click)="addUnit(unitNameInput, unitCnpjInput)">+ Adicionar</button>
              </div>
            </div>

            <!-- Setores -->
            <div class="form-group full-width">
              <label class="dynamic-label">ğŸ·ï¸ Setores</label>
              <div class="dynamic-items">
                <div *ngFor="let s of dynamicSectors; let i=index" class="dynamic-item">
                  <span class="item-name">{{s}}</span>
                  <button type="button" class="btn-remove" (click)="removeSector(i)" title="Remover">âœ•</button>
                </div>
              </div>
              <div class="add-dynamic sector-add">
                <input #sectorInput placeholder="Nome do setor" class="dynamic-input" />
                <button type="button" class="btn btn-secondary btn-sm" (click)="addSector(sectorInput)">+ Adicionar</button>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" [disabled]="loadingCompanyForm" class="btn btn-primary">
                {{ loadingCompanyForm ? 'â³ Adicionando empresa...' : 'ğŸ’¾ Salvar Empresa' }}
              </button>
            </div>
            <div class="form-message" *ngIf="companyFormMsg" [class.success]="companyFormMsg.includes('âœ…')" [class.error]="companyFormMsg.includes('âŒ') || companyFormMsg.includes('âš ï¸')">
              {{companyFormMsg}}
              <button *ngIf="companyFormMsg.includes('âš ï¸')" type="button" class="btn-retry" (click)="submitCreateCompany()" title="Tentar novamente">
                ğŸ”„ Tentar Novamente
              </button>
            </div>
          </form>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Modal de EdiÃ§Ã£o de UsuÃ¡rio -->
<div class="modal-overlay" *ngIf="showEditUserModal" (click)="closeEditUserModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Editar UsuÃ¡rio</h2>
      <button class="modal-close" type="button" (click)="closeEditUserModal()" title="Fechar modal">âœ•</button>
    </div>

    <form (ngSubmit)="submitEditUser()" [formGroup]="editUserForm" class="form-grid">
      <div class="form-group full-width">
        <label>Nome *</label>
        <input placeholder="Nome completo" formControlName="name" />
      </div>
      <div class="form-group full-width">
        <label>Email *</label>
        <input placeholder="email@exemplo.com" formControlName="email" type="email" />
      </div>
      <div class="form-group">
        <label>Telefone</label>
        <input placeholder="(11) 99999-9999" formControlName="phone" />
      </div>
      <div class="form-group">
        <label>CPF</label>
        <input placeholder="000.000.000-00" formControlName="cpf" />
      </div>
      <div class="form-group">
        <label>Sigla Conselho</label>
        <input placeholder="CRM, CREA, etc" formControlName="siglaConselhoClasse" />
      </div>
      <div class="form-group">
        <label>Conselho Classe</label>
        <input placeholder="Conselho Regional" formControlName="conselhoClasse" />
      </div>
      <div class="form-group full-width">
        <label>Especialidade</label>
        <input placeholder="Especialidade profissional" formControlName="especialidade" />
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" (click)="closeEditUserModal()">Cancelar</button>
        <button type="submit" class="btn btn-primary">ğŸ’¾ Salvar AlteraÃ§Ãµes</button>
      </div>
      <div class="form-message" *ngIf="editUserFormMsg" [class.success]="editUserFormMsg.includes('sucesso')">{{editUserFormMsg}}</div>
    </form>
  </div>
</div>

<!-- Modal de EdiÃ§Ã£o de Empresa -->
<div class="modal-overlay" *ngIf="showEditCompanyModal" (click)="closeEditCompanyModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Editar Empresa</h2>
      <button class="modal-close" type="button" (click)="closeEditCompanyModal()" title="Fechar modal">âœ•</button>
    </div>

    <form (ngSubmit)="submitEditCompany()" [formGroup]="editCompanyForm" class="form-grid">
      <div class="form-group full-width">
        <label>Nome da Empresa *</label>
        <input placeholder="RazÃ£o social" formControlName="companyName" />
      </div>
      <div class="form-group full-width">
        <label>CNPJ *</label>
        <input placeholder="00.000.000/0000-00" formControlName="companyCnpj" (change)="onCnpjChange($event.target.value, 'company')" />
      </div>

      <!-- Unidades -->
      <div class="form-group full-width">
        <label class="dynamic-label">ğŸ­ Unidades</label>
        <div class="dynamic-items">
          <div *ngFor="let u of dynamicUnits; let i = index" class="dynamic-item">
            <span class="item-name">{{u.name}}</span>
            <span class="item-detail" *ngIf="u.cnpj">{{u.cnpj | cnpjFormat}}</span>
            <span class="item-detail text-muted" *ngIf="!u.cnpj">(sem CNPJ)</span>
            <button type="button" class="btn-remove" (click)="removeUnitWithDelete(i)" title="Remover">âœ•</button>
          </div>
        </div>
        <div class="add-dynamic">
          <input #unitNameEditInput placeholder="Nome da unidade" class="dynamic-input" />
          <input #unitCnpjEditInput placeholder="CNPJ" class="dynamic-input" (change)="onUnitCnpjChange($event.target.value, unitNameEditInput)" />
          <button type="button" class="btn btn-secondary btn-sm" (click)="addUnit(unitNameEditInput, unitCnpjEditInput)">+ Adicionar</button>
        </div>
      </div>

      <!-- Setores -->
      <div class="form-group full-width">
        <label class="dynamic-label">ğŸ·ï¸ Setores</label>
        <div class="dynamic-items">
          <div *ngFor="let s of dynamicSectors; let i=index" class="dynamic-item">
            <span class="item-name">{{s}}</span>
            <button type="button" class="btn-remove" (click)="removeSectorWithDelete(i)" title="Remover">âœ•</button>
          </div>
        </div>
        <div class="add-dynamic sector-add">
          <input #sectorEditInput placeholder="Nome do setor" class="dynamic-input" />
          <button type="button" class="btn btn-secondary btn-sm" (click)="addSector(sectorEditInput)">+ Adicionar</button>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" (click)="closeEditCompanyModal()">Cancelar</button>
        <button type="submit" class="btn btn-primary">ğŸ’¾ Salvar AlteraÃ§Ãµes</button>
      </div>
      <div class="form-message" *ngIf="editCompanyFormMsg" [class.success]="editCompanyFormMsg.includes('sucesso')">{{editCompanyFormMsg}}</div>
    </form>
  </div>
</div>
