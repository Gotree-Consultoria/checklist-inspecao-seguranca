<section class="aep-page page">
  <div class="container">
    <h1 class="page-title">Avaliação Ergonômica Preliminar (AEP)</h1>
    <form [formGroup]="form" class="aep-form" (ngSubmit)="submit()">
      <fieldset class="aep-header">
        <legend>Dados da Avaliação</legend>
        <div class="fields">
          <div class="field-row">
            <label for="aepCompany" class="field-label">Empresa Cliente:</label>
            <div class="field-input">
              <select id="aepCompany" formControlName="company" class="form-select" title="Empresa">
                <option value="">{{ loadingCompanies ? 'Carregando...' : 'Selecione...' }}</option>
                <option *ngFor="let c of companies" [value]="c.id || c.name" [attr.data-cnpj]="c.cnpj">{{c.name}}</option>
              </select>
            </div>
          </div>

          <div class="field-row">
            <label for="aepCnpj" class="field-label">CNPJ:</label>
            <div class="field-input">
              <input id="aepCnpj" formControlName="cnpj" class="form-control" readonly title="CNPJ" />
            </div>
          </div>

          <div class="section-separator" aria-hidden="true"></div>

          <div class="field-row">
            <label for="aepEvaluator" class="field-label">Avaliador:</label>
            <div class="field-input">
              <input id="aepEvaluator" formControlName="evaluator" class="form-control" title="Avaliador" placeholder="Nome do avaliador" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepSigla" class="field-label">Sigla do Conselho:</label>
            <div class="field-input">
              <input id="aepSigla" formControlName="sigla" class="form-control" title="Sigla do Conselho" placeholder="Sigla (ex: TST)" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepRegistro" class="field-label">Registro no Conselho:</label>
            <div class="field-input">
              <input id="aepRegistro" formControlName="registro" class="form-control" title="Registro" placeholder="Número do registro" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepEspecialidade" class="field-label">Especialidade:</label>
            <div class="field-input">
              <input id="aepEspecialidade" formControlName="especialidade" class="form-control" title="Especialidade" placeholder="Ex: Técnico de Segurança do Trabalho" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepDate" class="field-label">Data da Avaliação:</label>
            <div class="field-input">
              <input id="aepDate" formControlName="date" class="form-control" type="date" title="Data" />
            </div>
          </div>

          <div class="field-row">
            <label for="aepFunction" class="field-label">Função Avaliada:</label>
            <div class="field-input">
              <input id="aepFunction" formControlName="funcao" class="form-control" placeholder="Ex: Operador de Produção" title="Função" />
            </div>
          </div>
        </div>
      </fieldset>

      <!-- Assinatura: informativo apenas — assinatura será realizada externamente por fisioterapeuta (ICP-Brasil/Gov). -->
      <div class="aep-signature-note">
        <strong>Assinatura:</strong>
        <p>A assinatura deste documento deve ser realizada por um fisioterapeuta (assinatura externa válida via ICP-Brasil / Governo). Não coletamos assinatura eletrônica aqui. O documento pode ser emitido imediatamente e permanecerá editável.</p>
      </div>

      <fieldset class="aep-risks">
        <legend>Riscos Identificados por Função</legend>
        <div class="table-wrapper">
          <table class="aep-table">
            <thead>
              <tr>
                <th class="col-sel">Sel</th>
                <th class="col-risk">Risco</th>
                <th>Fator de Risco</th>
              </tr>
            </thead>
            <tbody id="aepRisks">
              <tr *ngFor="let rf of riskFactors; let i = index">
                <td class="chk"><input title="Selecionar risco" type="checkbox" [id]="'risk_'+i" (change)="toggleRisk(rf,$event)" name="risks" [value]="rf" [checked]="selectedRisks.includes(rf)"></td>
                <td class="tipo">ERGONÔMICO</td>
                <td class="fator"><label [for]="'risk_'+i">{{rf}}</label></td>
              </tr>
            </tbody>
          </table>
        </div>
      </fieldset>

      <!-- Campos para registro da assinatura externa (opcionais) -->
      <fieldset class="aep-signature-fields">
        <div class="fields">
          <div class="field-row">
            <label for="fisioterapeutaSelect" class="field-label">Selecionar Fisioterapeuta:</label>
            <div class="field-input">
              <div class="physio-select-row">
                <select id="fisioterapeutaSelect" formControlName="fisioterapeutaId" class="form-select" title="Fisioterapeuta">
                  <option value="">{{ loadingPhysios ? 'Carregando...' : 'Selecione um fisioterapeuta...' }}</option>
                  <option *ngFor="let p of physiotherapists" [value]="p.id || p._id">{{ (p.name || p.nome) + ((p.crefito || p.CREFITO) ? (' | ' + (p.crefito || p.CREFITO)) : '') }}</option>
                </select>
                <button type="button" class="btn-secondary" (click)="creatingPhysio = !creatingPhysio">Novo</button>
              </div>
            </div>
          </div>

          <div class="physio-create-inline" *ngIf="creatingPhysio">
            <div class="field-row">
              <label class="field-label">Novo Fisioterapeuta:</label>
              <div class="field-input">
                <input class="form-control" [(ngModel)]="newPhysioName" [ngModelOptions]="{standalone: true}" placeholder="Nome" />
              </div>
            </div>
            <div class="field-row">
              <label class="field-label">CREFITO:</label>
              <div class="field-input">
                <input class="form-control" [(ngModel)]="newPhysioCrefito" [ngModelOptions]="{standalone: true}" placeholder="CREFITO" />
              </div>
            </div>
            <div class="field-row">
              <label class="field-label">&nbsp;</label>
              <div class="field-input physio-create-actions">
                <button type="button" class="btn-primary" (click)="createPhysiotherapist()">Salvar</button>
                <button type="button" class="btn-secondary" (click)="cancelCreatePhysio()">Cancelar</button>
              </div>
            </div>
          </div>

          <!-- Nome preenchido automaticamente a partir do select; campo de edição direto removido para evitar duplicidade -->
          <!-- Campo CREFITO removido conforme solicitado -->
        </div>
      </fieldset>

      <div class="aep-actions">
        <button type="submit" class="btn-primary">Emitir AEP</button>
        <button type="button" id="aepClear" class="btn-secondary" (click)="clear()">Limpar</button>
      </div>
      <div id="aepMsg" class="feedback" [ngClass]="{'success': msg.includes('✓'), 'error': msg.includes('✗'), 'warning': msg && !msg.includes('✓') && !msg.includes('✗')}">{{msg}}</div>
    </form>
  </div>
</section>